<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Request System</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .login-screen {
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 2rem;
            font-size: 2rem;
        }

        h2 {
            color: #555;
            margin-bottom: 1.5rem;
        }

        .login-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .contractor-btn {
            background: #4CAF50;
            color: white;
        }

        .contractor-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .manager-btn {
            background: #2196F3;
            color: white;
        }

        .manager-btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .service-btn, .nav-btn {
            background: #FF9800;
            color: white;
            margin: 0.5rem;
            min-width: 180px;
        }

        .service-btn:hover, .nav-btn:hover {
            background: #F57C00;
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: #4CAF50;
        }

        .nav-btn.active:hover {
            background: #45a049;
        }

        .back-btn {
            background: #757575;
            color: white;
            margin-top: 1rem;
        }

        .back-btn:hover {
            background: #616161;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .request-form {
            margin-top: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #333;
        }

        input, textarea, select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 0.8rem;
            border: 2px dashed #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f9f9f9;
        }

        .file-input-label:hover {
            border-color: #4CAF50;
            background: #f0f8f0;
        }

        .file-input-label.has-files {
            border-color: #4CAF50;
            background: #e8f5e8;
        }

        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .image-preview img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
            border: 2px solid #ddd;
        }

        .submit-btn {
            background: #4CAF50;
            color: white;
            width: 100%;
            margin-top: 1rem;
        }

        .contractor-nav {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .request-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .request-item {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f9f9f9;
            transition: all 0.3s ease;
        }

        .request-item:hover {
            border-color: #4CAF50;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .service-type {
            background: #2196F3;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-badge.quoted {
            background: #FF9800;
            color: white;
        }

        .status-badge.approved {
            background: #4CAF50;
            color: white;
        }

        .status-badge.accepted {
            background: #4CAF50;
            color: white;
        }

        .status-badge.completed {
            background: #607D8B;
            color: white;
        }

        .priority {
            font-weight: bold;
        }

        .priority.high { color: #f44336; }
        .priority.medium { color: #ff9800; }
        .priority.low { color: #4caf50; }

        .accept-btn {
            background: #4CAF50;
            color: white;
            padding: 0.5rem 1rem;
            margin-top: 0.5rem;
        }

        .quote-btn {
            background: #FF9800;
            color: white;
            padding: 0.5rem 1rem;
            margin-top: 0.5rem;
        }

        .approve-btn {
            background: #4CAF50;
            color: white;
            padding: 0.5rem 1rem;
            margin-top: 0.5rem;
            margin-right: 0.5rem;
        }

        .reject-btn {
            background: #f44336;
            color: white;
            padding: 0.5rem 1rem;
            margin-top: 0.5rem;
        }

        .complete-btn {
            background: #2196F3;
            color: white;
            padding: 0.5rem 1rem;
            margin-top: 0.5rem;
            margin-left: 0.5rem;
        }

        .quote-form {
            background: #f0f8f0;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            border: 2px solid #4CAF50;
        }

        .quote-display {
            background: #fff3e0;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            border: 2px solid #FF9800;
        }

        .quote-price {
            font-size: 1.2rem;
            font-weight: bold;
            color: #FF9800;
        }

        .request-images {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .request-images img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .request-images img:hover {
            transform: scale(1.05);
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            border: 1px solid #f5c6cb;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }

        .modal-content {
            display: block;
            margin: auto;
            max-width: 90%;
            max-height: 90%;
            margin-top: 5%;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #bbb;
        }

        .firebase-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .firebase-status.connected {
            background: #4CAF50;
            color: white;
        }

        .firebase-status.error {
            background: #f44336;
            color: white;
        }

        @media (max-width: 600px) {
            .login-buttons, .contractor-nav {
                flex-direction: column;
            }
            
            button {
                min-width: auto;
            }

            .request-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase Connection Status -->
    <div id="firebaseStatus" class="firebase-status">Connecting...</div>

    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen">
            <h1>ðŸ”¥ Service Request System</h1>
            <p style="margin-bottom: 2rem; color: #666;">Firebase-Powered Demo</p>
            <div class="login-buttons">
                <button class="contractor-btn" onclick="showContractorDashboard()">
                    Contractor Login
                </button>
                <button class="manager-btn" onclick="showManagerDashboard()">
                    Project Manager Login
                </button>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="loading hidden">
            <h2>Loading...</h2>
            <p>Connecting to Firebase...</p>
        </div>

        <!-- Project Manager Dashboard -->
        <div id="managerDashboard" class="hidden">
            <h2>Project Manager Dashboard</h2>
            
            <div class="contractor-nav">
                <button class="nav-btn active" id="createRequestBtn" onclick="showCreateRequestSection()">
                    Create Request
                </button>
                <button class="nav-btn" id="pendingQuotesBtn" onclick="showPendingQuotes()">
                    Pending Quotes (<span id="pendingQuotesCount">0</span>)
                </button>
                <button class="nav-btn" id="approvedJobsBtn" onclick="showApprovedJobs()">
                    Active Jobs (<span id="approvedJobsCount">0</span>)
                </button>
                <button class="nav-btn" id="completedJobsPMBtn" onclick="showCompletedJobsPM()">
                    Completed (<span id="completedJobsPMCount">0</span>)
                </button>
            </div>

            <!-- Create Request Section -->
            <div id="createRequestSection" class="hidden">
                <p style="margin-bottom: 1.5rem; color: #666;">Select a service to request:</p>
                
                <div class="login-buttons">
                    <button class="service-btn" onclick="showServiceForm('contractor')">
                        Request Contractor Services
                    </button>
                    <button class="service-btn" onclick="showServiceForm('handyman')">
                        Request Handyman Services
                    </button>
                    <button class="service-btn" onclick="showServiceForm('cleaning')">
                        Request Cleaning Services
                    </button>
                </div>
            </div>

            <!-- Pending Quotes Section -->
            <div id="pendingQuotesSection" class="hidden">
                <p style="margin-bottom: 1.5rem; color: #666;">Quotes waiting for your approval:</p>
                <div id="pendingQuotesList" class="request-list">
                    <!-- Pending quotes will be populated here -->
                </div>
            </div>

            <!-- Approved Jobs Section -->
            <div id="approvedJobsSection" class="hidden">
                <p style="margin-bottom: 1.5rem; color: #666;">Your active approved jobs:</p>
                <div id="approvedJobsList" class="request-list">
                    <!-- Approved jobs will be populated here -->
                </div>
            </div>

            <!-- Completed Jobs Section for PM -->
            <div id="completedJobsPMSection" class="hidden">
                <p style="margin-bottom: 1.5rem; color: #666;">Your completed jobs:</p>
                <div id="completedJobsPMList" class="request-list">
                    <!-- Completed jobs will be populated here -->
                </div>
            </div>
            
            <button class="back-btn" onclick="showLogin()">Back to Login</button>
        </div>

        <!-- Service Request Form -->
        <div id="serviceForm" class="hidden">
            <h2 id="formTitle">Request Service</h2>
            
            <div id="successMessage" class="success-message hidden">
                Request submitted successfully! It will be available for contractors to view.
            </div>
            
            <div id="errorMessage" class="error-message hidden">
                Error submitting request. Please try again.
            </div>
            
            <div class="request-form">
                <div class="form-group">
                    <label for="projectName">Project Name:</label>
                    <input type="text" id="projectName" required>
                </div>
                
                <div class="form-group">
                    <label for="description">Description:</label>
                    <textarea id="description" placeholder="Describe the work needed..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="priority">Priority:</label>
                    <select id="priority" required>
                        <option value="">Select Priority</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="deadline">Deadline:</label>
                    <input type="date" id="deadline" required>
                </div>

                <div class="form-group">
                    <label for="jobImages">Job Images (optional):</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="jobImages" multiple accept="image/*" onchange="handleImageUpload(event)">
                        <label for="jobImages" class="file-input-label" id="imageLabel">
                            ðŸ“· Click to upload images or drag and drop
                        </label>
                    </div>
                    <div id="imagePreview" class="image-preview"></div>
                </div>
                
                <button class="submit-btn" onclick="submitRequest()" id="submitBtn">Submit Request</button>
            </div>
            
            <button class="back-btn" onclick="showManagerDashboard()">Back to Dashboard</button>
        </div>

        <!-- Contractor Dashboard -->
        <div id="contractorDashboard" class="hidden">
            <h2>Contractor Dashboard</h2>
            
            <div class="contractor-nav">
                <button class="nav-btn active" id="openRequestsBtn" onclick="showOpenRequests()">
                    Open Requests
                </button>
                <button class="nav-btn" id="quotedJobsBtn" onclick="showQuotedJobs()">
                    Quoted (<span id="quotedJobsCount">0</span>)
                </button>
                <button class="nav-btn" id="myJobsBtn" onclick="showMyJobs()">
                    Active Jobs (<span id="myJobsCount">0</span>)
                </button>
                <button class="nav-btn" id="completedJobsBtn" onclick="showCompletedJobs()">
                    Completed (<span id="completedJobsCount">0</span>)
                </button>
            </div>
            
            <!-- Open Requests Tab -->
            <div id="openRequestsTab">
                <p style="margin-bottom: 1.5rem; color: #666;">Available service requests:</p>
                <div id="requestList" class="request-list">
                    <!-- Requests will be populated here -->
                </div>
            </div>

            <!-- Quoted Jobs Tab -->
            <div id="quotedJobsTab" class="hidden">
                <p style="margin-bottom: 1.5rem; color: #666;">Jobs you have quoted (waiting for approval):</p>
                <div id="quotedJobsList" class="request-list">
                    <!-- Quoted jobs will be populated here -->
                </div>
            </div>

            <!-- My Jobs Tab -->
            <div id="myJobsTab" class="hidden">
                <p style="margin-bottom: 1.5rem; color: #666;">Your active approved jobs:</p>
                <div id="myJobsList" class="request-list">
                    <!-- Accepted jobs will be populated here -->
                </div>
            </div>

            <!-- Completed Jobs Tab -->
            <div id="completedJobsTab" class="hidden">
                <p style="margin-bottom: 1.5rem; color: #666;">Jobs you have completed:</p>
                <div id="completedJobsList" class="request-list">
                    <!-- Completed jobs will be populated here -->
                </div>
            </div>
            
            <button class="back-btn" onclick="showLogin()">Back to Login</button>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal" onclick="closeModal()">
        <span class="close">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD1MC1ZxSZt1seTf6YMAP1aPCT4ULSiTuU",
            authDomain: "service-request-demo-2c974.firebaseapp.com",
            projectId: "service-request-demo-2c974",
            storageBucket: "service-request-demo-2c974.firebasestorage.app",
            messagingSenderId: "300478912426",
            appId: "1:300478912426:web:2a2bc9b6c03a328cc47dd3",
            measurementId: "G-HSWF56G61L"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();

        // Global variables
        let currentServiceType = '';
        let uploadedImages = [];
        let currentUser = null;
        let unsubscribeRequests = null;

        // Firebase connection status
        function updateFirebaseStatus(status, message) {
            const statusEl = document.getElementById('firebaseStatus');
            statusEl.className = `firebase-status ${status}`;
            statusEl.textContent = message;
        }

        // Initialize Firebase connection
        async function initializeFirebase() {
            try {
                // Test Firestore connection
                await db.collection('requests').limit(1).get();
                updateFirebaseStatus('connected', 'ðŸ”¥ Firebase Connected');
                
                // Load initial data
                setupRealtimeListeners();
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateFirebaseStatus('error', 'âŒ Firebase Error');
            }
        }

        // Setup real-time listeners for data
        function setupRealtimeListeners() {
            // Listen for requests changes
            unsubscribeRequests = db.collection('requests')
                .orderBy('submittedAt', 'desc')
                .onSnapshot((snapshot) => {
                    console.log('Real-time update: requests changed');
                    updateCounters();
                    refreshCurrentView();
                }, (error) => {
                    console.error('Error listening to requests:', error);
                });
        }

        // Refresh current view based on active screen
        function refreshCurrentView() {
            if (!document.getElementById('loginScreen').classList.contains('hidden')) return;
            
            if (currentUser === 'contractor') {
                const activeTab = document.querySelector('.contractor-nav .nav-btn.active');
                if (activeTab) {
                    const tabId = activeTab.id;
                    if (tabId === 'openRequestsBtn') displayRequests();
                    else if (tabId === 'quotedJobsBtn') displayQuotedJobs();
                    else if (tabId === 'myJobsBtn') displayMyJobs();
                    else if (tabId === 'completedJobsBtn') displayCompletedJobs();
                }
            } else if (currentUser === 'manager') {
                const activeTab = document.querySelector('#managerDashboard .nav-btn.active');
                if (activeTab) {
                    const tabId = activeTab.id;
                    if (tabId === 'pendingQuotesBtn') displayPendingQuotes();
                    else if (tabId === 'approvedJobsBtn') displayApprovedJobs();
                    else if (tabId === 'completedJobsPMBtn') displayCompletedJobsPM();
                }
            }
        }

        // Show different screens
        function showLogin() {
            hideAllScreens();
            document.getElementById('loginScreen').classList.remove('hidden');
            currentUser = null;
            if (unsubscribeRequests) {
                unsubscribeRequests();
                unsubscribeRequests = null;
            }
        }

        function showManagerDashboard() {
            hideAllScreens();
            document.getElementById('managerDashboard').classList.remove('hidden');
            currentUser = 'manager';
            hideAllManagerTabs();
            setActiveManagerTab('createRequestBtn');
            updateCounters();
            if (!unsubscribeRequests) setupRealtimeListeners();
        }

        function showContractorDashboard() {
            hideAllScreens();
            document.getElementById('contractorDashboard').classList.remove('hidden');
            currentUser = 'contractor';
            showOpenRequests();
            updateCounters();
            if (!unsubscribeRequests) setupRealtimeListeners();
        }

        function showServiceForm(serviceType) {
            hideAllScreens();
            currentServiceType = serviceType;
            document.getElementById('serviceForm').classList.remove('hidden');
            document.getElementById('formTitle').textContent = `Request ${capitalize(serviceType)} Services`;
            document.getElementById('successMessage').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            clearForm();
        }

        function hideAllScreens() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('managerDashboard').classList.add('hidden');
            document.getElementById('serviceForm').classList.add('hidden');
            document.getElementById('contractorDashboard').classList.add('hidden');
        }

        // Project Manager navigation
        function showCreateRequestSection() {
            hideAllManagerTabs();
            document.getElementById('createRequestSection').classList.remove('hidden');
            setActiveManagerTab('createRequestBtn');
        }

        function showPendingQuotes() {
            hideAllManagerTabs();
            document.getElementById('pendingQuotesSection').classList.remove('hidden');
            setActiveManagerTab('pendingQuotesBtn');
            displayPendingQuotes();
        }

        function showApprovedJobs() {
            hideAllManagerTabs();
            document.getElementById('approvedJobsSection').classList.remove('hidden');
            setActiveManagerTab('approvedJobsBtn');
            displayApprovedJobs();
        }

        function showCompletedJobsPM() {
            hideAllManagerTabs();
            document.getElementById('completedJobsPMSection').classList.remove('hidden');
            setActiveManagerTab('completedJobsPMBtn');
            displayCompletedJobsPM();
        }

        function hideAllManagerTabs() {
            document.getElementById('createRequestSection').classList.add('hidden');
            document.getElementById('pendingQuotesSection').classList.add('hidden');
            document.getElementById('approvedJobsSection').classList.add('hidden');
            document.getElementById('completedJobsPMSection').classList.add('hidden');
        }

        function setActiveManagerTab(activeId) {
            document.getElementById('createRequestBtn').classList.remove('active');
            document.getElementById('pendingQuotesBtn').classList.remove('active');
            document.getElementById('approvedJobsBtn').classList.remove('active');
            document.getElementById('completedJobsPMBtn').classList.remove('active');
            document.getElementById(activeId).classList.add('active');
        }

        // Contractor navigation
        function showOpenRequests() {
            hideAllTabs();
            document.getElementById('openRequestsTab').classList.remove('hidden');
            setActiveTab('openRequestsBtn');
            displayRequests();
        }

        function showQuotedJobs() {
            hideAllTabs();
            document.getElementById('quotedJobsTab').classList.remove('hidden');
            setActiveTab('quotedJobsBtn');
            displayQuotedJobs();
        }

        function showMyJobs() {
            hideAllTabs();
            document.getElementById('myJobsTab').classList.remove('hidden');
            setActiveTab('myJobsBtn');
            displayMyJobs();
        }

        function showCompletedJobs() {
            hideAllTabs();
            document.getElementById('completedJobsTab').classList.remove('hidden');
            setActiveTab('completedJobsBtn');
            displayCompletedJobs();
        }

        function hideAllTabs() {
            document.getElementById('openRequestsTab').classList.add('hidden');
            document.getElementById('quotedJobsTab').classList.add('hidden');
            document.getElementById('myJobsTab').classList.add('hidden');
            document.getElementById('completedJobsTab').classList.add('hidden');
        }

        function setActiveTab(activeId) {
            document.getElementById('openRequestsBtn').classList.remove('active');
            document.getElementById('quotedJobsBtn').classList.remove('active');
            document.getElementById('myJobsBtn').classList.remove('active');
            document.getElementById('completedJobsBtn').classList.remove('active');
            document.getElementById(activeId).classList.add('active');
        }

        // Image handling
        function handleImageUpload(event) {
            const files = Array.from(event.target.files);
            uploadedImages = [];
            const preview = document.getElementById('imagePreview');
            const label = document.getElementById('imageLabel');
            
            preview.innerHTML = '';
            
            if (files.length === 0) {
                label.textContent = 'ðŸ“· Click to upload images or drag and drop';
                label.classList.remove('has-files');
                return;
            }

            label.textContent = `ðŸ“· ${files.length} image(s) selected`;
            label.classList.add('has-files');

            files.forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedImages.push({
                            file: file,
                            dataUrl: e.target.result
                        });
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = `Preview ${index + 1}`;
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Upload images to Firebase Storage
        async function uploadImages(requestId) {
            const imageUrls = [];
            
            for (let i = 0; i < uploadedImages.length; i++) {
                const imageData = uploadedImages[i];
                const fileName = `requests/${requestId}/image_${i}_${Date.now()}`;
                const storageRef = storage.ref().child(fileName);
                
                try {
                    const snapshot = await storageRef.put(imageData.file);
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    imageUrls.push(downloadURL);
                } catch (error) {
                    console.error('Error uploading image:', error);
                }
            }
            
            return imageUrls;
        }

        // Submit request to Firebase
        async function submitRequest() {
            const projectName = document.getElementById('projectName').value;
            const description = document.getElementById('description').value;
            const priority = document.getElementById('priority').value;
            const deadline = document.getElementById('deadline').value;

            if (!projectName || !description || !priority || !deadline) {
                alert('Please fill in all required fields');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = 'Submitting...';
            submitBtn.disabled = true;

            try {
                // Create request document
                const requestRef = db.collection('requests').doc();
                const requestId = requestRef.id;

                // Upload images if any
                const imageUrls = await uploadImages(requestId);

                const request = {
                    id: requestId,
                    serviceType: currentServiceType,
                    projectName: projectName,
                    description: description,
                    priority: priority,
                    deadline: deadline,
                    images: imageUrls,
                    status: 'pending',
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    submittedBy: 'manager',
                    quotedBy: null,
                    quotedAt: null,
                    quoteAmount: null,
                    estimatedTime: null,
                    quoteNotes: null,
                    approvedAt: null,
                    completedAt: null
                };

                await requestRef.set(request);

                document.getElementById('successMessage').classList.remove('hidden');
                clearForm();
                
            } catch (error) {
                console.error('Error submitting request:', error);
                document.getElementById('errorMessage').classList.remove('hidden');
            } finally {
                submitBtn.textContent = 'Submit Request';
                submitBtn.disabled = false;
            }
        }

        // Clear form
        function clearForm() {
            document.getElementById('projectName').value = '';
            document.getElementById('description').value = '';
            document.getElementById('priority').value = '';
            document.getElementById('deadline').value = '';
            document.getElementById('jobImages').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('imageLabel').textContent = 'ðŸ“· Click to upload images or drag and drop';
            document.getElementById('imageLabel').classList.remove('has-files');
            uploadedImages = [];
        }

        // Display requests for contractors
        async function displayRequests() {
            const requestList = document.getElementById('requestList');
            requestList.innerHTML = '<div class="loading">Loading requests...</div>';
            
            try {
                const snapshot = await db.collection('requests')
                    .where('status', '==', 'pending')
                    .orderBy('submittedAt', 'desc')
                    .get();

                if (snapshot.empty) {
                    requestList.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No open requests available at the moment.</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const request = doc.data();
                    const submittedDate = request.submittedAt ? request.submittedAt.toDate().toLocaleDateString() : 'Unknown';
                    
                    html += `
                        <div class="request-item">
                            <div class="request-header">
                                <span class="service-type">${capitalize(request.serviceType)}</span>
                                <span class="priority ${request.priority}">Priority: ${capitalize(request.priority)}</span>
                            </div>
                            <h3>${request.projectName}</h3>
                            <p><strong>Description:</strong> ${request.description}</p>
                            <p><strong>Deadline:</strong> ${request.deadline}</p>
                            <p><strong>Submitted:</strong> ${submittedDate}</p>
                            ${request.images && request.images.length > 0 ? `
                                <div class="request-images">
                                    ${request.images.map((img, index) => `
                                        <img src="${img}" alt="Job image ${index + 1}" onclick="openModal('${img}')" />
                                    `).join('')}
                                </div>
                            ` : ''}
                            <button class="quote-btn" onclick="showQuoteForm('${request.id}')">Submit Quote</button>
                            <div id="quoteForm${request.id}" class="quote-form hidden">
                                <h4>Submit Your Quote</h4>
                                <div class="form-group">
                                    <label>Quote Amount ($):</label>
                                    <input type="number" id="quoteAmount${request.id}" placeholder="Enter your quote" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>Estimated Completion Time:</label>
                                    <input type="text" id="estimatedTime${request.id}" placeholder="e.g., 3-5 business days">
                                </div>
                                <div class="form-group">
                                    <label>Additional Notes:</label>
                                    <textarea id="quoteNotes${request.id}" placeholder="Any additional details about your quote..."></textarea>
                                </div>
                                <button class="submit-btn" onclick="submitQuote('${request.id}')">Submit Quote</button>
                                <button class="back-btn" onclick="hideQuoteForm('${request.id}')">Cancel</button>
                            </div>
                        </div>
                    `;
                });

                requestList.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading requests:', error);
                requestList.innerHTML = '<p style="text-align: center; color: #f44336; padding: 2rem;">Error loading requests. Please try again.</p>';
            }
        }

        // Display contractor's quoted jobs
        async function displayQuotedJobs() {
            const quotedJobsList = document.getElementById('quotedJobsList');
            quotedJobsList.innerHTML = '<div class="loading">Loading quoted jobs...</div>';
            
            try {
                const snapshot = await db.collection('requests')
                    .where('status', '==', 'quoted')
                    .where('quotedBy', '==', 'contractor')
                    .orderBy('quotedAt', 'desc')
                    .get();

                if (snapshot.empty) {
                    quotedJobsList.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No quoted jobs yet. Submit quotes for open requests!</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const request = doc.data();
                    const submittedDate = request.submittedAt ? request.submittedAt.toDate().toLocaleDateString() : 'Unknown';
                    const quotedDate = request.quotedAt ? request.quotedAt.toDate().toLocaleDateString() : 'Unknown';
                    
                    html += `
                        <div class="request-item">
                            <div class="request-header">
                                <span class="service-type">${capitalize(request.serviceType)}</span>
                                <span class="status-badge quoted">Quoted - Awaiting Approval</span>
                                <span class="priority ${request.priority}">Priority: ${capitalize(request.priority)}</span>
                            </div>
                            <h3>${request.projectName}</h3>
                            <p><strong>Description:</strong> ${request.description}</p>
                            <p><strong>Deadline:</strong> ${request.deadline}</p>
                            <p><strong>Submitted:</strong> ${submittedDate}</p>
                            <p><strong>Quoted:</strong> ${quotedDate}</p>
                            ${request.images && request.images.length > 0 ? `
                                <div class="request-images">
                                    ${request.images.map((img, index) => `
                                        <img src="${img}" alt="Job image ${index + 1}" onclick="openModal('${img}')" />
                                    `).join('')}
                                </div>
                            ` : ''}
                            <div class="quote-display">
                                <p><strong>Your Quote:</strong> <span class="quote-price">${request.quoteAmount}</span></p>
                                <p><strong>Estimated Time:</strong> ${request.estimatedTime}</p>
                                ${request.quoteNotes ? `<p><strong>Notes:</strong> ${request.quoteNotes}</p>` : ''}
                            </div>
                        </div>
                    `;
                });

                quotedJobsList.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading quoted jobs:', error);
                quotedJobsList.innerHTML = '<p style="text-align: center; color: #f44336; padding: 2rem;">Error loading quoted jobs. Please try again.</p>';
            }
        }

        // Display contractor's active jobs
        async function displayMyJobs() {
            const myJobsList = document.getElementById('myJobsList');
            myJobsList.innerHTML = '<div class="loading">Loading active jobs...</div>';
            
            try {
                const snapshot = await db.collection('requests')
                    .where('status', '==', 'approved')
                    .where('quotedBy', '==', 'contractor')
                    .orderBy('approvedAt', 'desc')
                    .get();

                if (snapshot.empty) {
                    myJobsList.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No active jobs yet. Submit quotes to get started!</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const request = doc.data();
                    const submittedDate = request.submittedAt ? request.submittedAt.toDate().toLocaleDateString() : 'Unknown';
                    const quotedDate = request.quotedAt ? request.quotedAt.toDate().toLocaleDateString() : 'Unknown';
                    const approvedDate = request.approvedAt ? request.approvedAt.toDate().toLocaleDateString() : 'Unknown';
                    
                    html += `
                        <div class="request-item">
                            <div class="request-header">
                                <span class="service-type">${capitalize(request.serviceType)}</span>
                                <span class="status-badge approved">Approved - In Progress</span>
                                <span class="priority ${request.priority}">Priority: ${capitalize(request.priority)}</span>
                            </div>
                            <h3>${request.projectName}</h3>
                            <p><strong>Description:</strong> ${request.description}</p>
                            <p><strong>Deadline:</strong> ${request.deadline}</p>
                            <p><strong>Submitted:</strong> ${submittedDate}</p>
                            <p><strong>Quoted:</strong> ${quotedDate}</p>
                            <p><strong>Approved:</strong> ${approvedDate}</p>
                            ${request.images && request.images.length > 0 ? `
                                <div class="request-images">
                                    ${request.images.map((img, index) => `
                                        <img src="${img}" alt="Job image ${index + 1}" onclick="openModal('${img}')" />
                                    `).join('')}
                                </div>
                            ` : ''}
                            <div class="quote-display">
                                <p><strong>Approved Quote:</strong> <span class="quote-price">${request.quoteAmount}</span></p>
                                <p><strong>Estimated Time:</strong> ${request.estimatedTime}</p>
                                ${request.quoteNotes ? `<p><strong>Notes:</strong> ${request.quoteNotes}</p>` : ''}
                            </div>
                            <button class="complete-btn" onclick="completeJob('${request.id}')">Mark as Complete</button>
                        </div>
                    `;
                });

                myJobsList.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading active jobs:', error);
                myJobsList.innerHTML = '<p style="text-align: center; color: #f44336; padding: 2rem;">Error loading active jobs. Please try again.</p>';
            }
        }

        // Display contractor's completed jobs
        async function displayCompletedJobs() {
            const completedJobsList = document.getElementById('completedJobsList');
            completedJobsList.innerHTML = '<div class="loading">Loading completed jobs...</div>';
            
            try {
                const snapshot = await db.collection('requests')
                    .where('status', '==', 'completed')
                    .where('quotedBy', '==', 'contractor')
                    .orderBy('completedAt', 'desc')
                    .get();

                if (snapshot.empty) {
                    completedJobsList.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No completed jobs yet. Keep up the great work!</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const request = doc.data();
                    const submittedDate = request.submittedAt ? request.submittedAt.toDate().toLocaleDateString() : 'Unknown';
                    const quotedDate = request.quotedAt ? request.quotedAt.toDate().toLocaleDateString() : 'Unknown';
                    const approvedDate = request.approvedAt ? request.approvedAt.toDate().toLocaleDateString() : 'Unknown';
                    const completedDate = request.completedAt ? request.completedAt.toDate().toLocaleDateString() : 'Unknown';
                    
                    html += `
                        <div class="request-item">
                            <div class="request-header">
                                <span class="service-type">${capitalize(request.serviceType)}</span>
                                <span class="status-badge completed">Completed</span>
                                <span class="priority ${request.priority}">Priority: ${capitalize(request.priority)}</span>
                            </div>
                            <h3>${request.projectName}</h3>
                            <p><strong>Description:</strong> ${request.description}</p>
                            <p><strong>Original Deadline:</strong> ${request.deadline}</p>
                            <p><strong>Submitted:</strong> ${submittedDate}</p>
                            <p><strong>Quoted:</strong> ${quotedDate}</p>
                            <p><strong>Approved:</strong> ${approvedDate}</p>
                            <p><strong>Completed:</strong> ${completedDate}</p>
                            ${request.images && request.images.length > 0 ? `
                                <div class="request-images">
                                    ${request.images.map((img, index) => `
                                        <img src="${img}" alt="Job image ${index + 1}" onclick="openModal('${img}')" />
                                    `).join('')}
                                </div>
                            ` : ''}
                            <div class="quote-display">
                                <p><strong>Final Quote:</strong> <span class="quote-price">${request.quoteAmount}</span></p>
                                <p><strong>Completion Time:</strong> ${request.estimatedTime}</p>
                                ${request.quoteNotes ? `<p><strong>Notes:</strong> ${request.quoteNotes}</p>` : ''}
                            </div>
                        </div>
                    `;
                });

                completedJobsList.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading completed jobs:', error);
                completedJobsList.innerHTML = '<p style="text-align: center; color: #f44336; padding: 2rem;">Error loading completed jobs. Please try again.</p>';
            }
        }

        // Display pending quotes for Project Manager
        async function displayPendingQuotes() {
            const pendingQuotesList = document.getElementById('pendingQuotesList');
            pendingQuotesList.innerHTML = '<div class="loading">Loading pending quotes...</div>';
            
            try {
                const snapshot = await db.collection('requests')
                    .where('status', '==', 'quoted')
                    .orderBy('quotedAt', 'desc')
                    .get();

                if (snapshot.empty) {
                    pendingQuotesList.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No pending quotes at the moment.</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const request = doc.data();
                    const submittedDate = request.submittedAt ? request.submittedAt.toDate().toLocaleDateString() : 'Unknown';
                    const quotedDate = request.quotedAt ? request.quotedAt.toDate().toLocaleDateString() : 'Unknown';
                    
                    html += `
                        <div class="request-item">
                            <div class="request-header">
                                <span class="service-type">${capitalize(request.serviceType)}</span>
                                <span class="status-badge quoted">Quote Received</span>
                                <span class="priority ${request.priority}">Priority: ${capitalize(request.priority)}</span>
                            </div>
                            <h3>${request.projectName}</h3>
                            <p><strong>Description:</strong> ${request.description}</p>
                            <p><strong>Deadline:</strong> ${request.deadline}</p>
                            <p><strong>Submitted:</strong> ${submittedDate}</p>
                            <p><strong>Quote Received:</strong> ${quotedDate}</p>
                            ${request.images && request.images.length > 0 ? `
                                <div class="request-images">
                                    ${request.images.map((img, index) => `
                                        <img src="${img}" alt="Job image ${index + 1}" onclick="openModal('${img}')" />
                                    `).join('')}
                                </div>
                            ` : ''}
                            <div class="quote-display">
                                <p><strong>Contractor Quote:</strong> <span class="quote-price">${request.quoteAmount}</span></p>
                                <p><strong>Estimated Time:</strong> ${request.estimatedTime}</p>
                                ${request.quoteNotes ? `<p><strong>Notes:</strong> ${request.quoteNotes}</p>` : ''}
                            </div>
                            <button class="approve-btn" onclick="approveQuote('${request.id}')">Approve Quote</button>
                            <button class="reject-btn" onclick="rejectQuote('${request.id}')">Reject Quote</button>
                        </div>
                    `;
                });

                pendingQuotesList.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading pending quotes:', error);
                pendingQuotesList.innerHTML = '<p style="text-align: center; color: #f44336; padding: 2rem;">Error loading pending quotes. Please try again.</p>';
            }
        }

        // Display approved jobs for Project Manager
        async function displayApprovedJobs() {
            const approvedJobsList = document.getElementById('approvedJobsList');
            approvedJobsList.innerHTML = '<div class="loading">Loading active jobs...</div>';
            
            try {
                const snapshot = await db.collection('requests')
                    .where('status', '==', 'approved')
                    .orderBy('approvedAt', 'desc')
                    .get();

                if (snapshot.empty) {
                    approvedJobsList.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No active jobs at the moment.</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const request = doc.data();
                    const submittedDate = request.submittedAt ? request.submittedAt.toDate().toLocaleDateString() : 'Unknown';
                    const approvedDate = request.approvedAt ? request.approvedAt.toDate().toLocaleDateString() : 'Unknown';
                    
                    html += `
                        <div class="request-item">
                            <div class="request-header">
                                <span class="service-type">${capitalize(request.serviceType)}</span>
                                <span class="status-badge approved">In Progress</span>
                                <span class="priority ${request.priority}">Priority: ${capitalize(request.priority)}</span>
                            </div>
                            <h3>${request.projectName}</h3>
                            <p><strong>Description:</strong> ${request.description}</p>
                            <p><strong>Deadline:</strong> ${request.deadline}</p>
                            <p><strong>Submitted:</strong> ${submittedDate}</p>
                            <p><strong>Approved:</strong> ${approvedDate}</p>
                            ${request.images && request.images.length > 0 ? `
                                <div class="request-images">
                                    ${request.images.map((img, index) => `
                                        <img src="${img}" alt="Job image ${index + 1}" onclick="openModal('${img}')" />
                                    `).join('')}
                                </div>
                            ` : ''}
                            <div class="quote-display">
                                <p><strong>Approved Quote:</strong> <span class="quote-price">${request.quoteAmount}</span></p>
                                <p><strong>Estimated Time:</strong> ${request.estimatedTime}</p>
                                ${request.quoteNotes ? `<p><strong>Notes:</strong> ${request.quoteNotes}</p>` : ''}
                            </div>
                        </div>
                    `;
                });

                approvedJobsList.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading approved jobs:', error);
                approvedJobsList.innerHTML = '<p style="text-align: center; color: #f44336; padding: 2rem;">Error loading approved jobs. Please try again.</p>';
            }
        }

        // Display completed jobs for Project Manager
        async function displayCompletedJobsPM() {
            const completedJobsList = document.getElementById('completedJobsPMList');
            completedJobsList.innerHTML = '<div class="loading">Loading completed jobs...</div>';
            
            try {
                const snapshot = await db.collection('requests')
                    .where('status', '==', 'completed')
                    .orderBy('completedAt', 'desc')
                    .get();

                if (snapshot.empty) {
                    completedJobsList.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No completed jobs yet.</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const request = doc.data();
                    const submittedDate = request.submittedAt ? request.submittedAt.toDate().toLocaleDateString() : 'Unknown';
                    const approvedDate = request.approvedAt ? request.approvedAt.toDate().toLocaleDateString() : 'Unknown';
                    const completedDate = request.completedAt ? request.completedAt.toDate().toLocaleDateString() : 'Unknown';
                    
                    html += `
                        <div class="request-item">
                            <div class="request-header">
                                <span class="service-type">${capitalize(request.serviceType)}</span>
                                <span class="status-badge completed">Completed</span>
                                <span class="priority ${request.priority}">Priority: ${capitalize(request.priority)}</span>
                            </div>
                            <h3>${request.projectName}</h3>
                            <p><strong>Description:</strong> ${request.description}</p>
                            <p><strong>Original Deadline:</strong> ${request.deadline}</p>
                            <p><strong>Submitted:</strong> ${submittedDate}</p>
                            <p><strong>Approved:</strong> ${approvedDate}</p>
                            <p><strong>Completed:</strong> ${completedDate}</p>
                            ${request.images && request.images.length > 0 ? `
                                <div class="request-images">
                                    ${request.images.map((img, index) => `
                                        <img src="${img}" alt="Job image ${index + 1}" onclick="openModal('${img}')" />
                                    `).join('')}
                                </div>
                            ` : ''}
                            <div class="quote-display">
                                <p><strong>Final Quote:</strong> <span class="quote-price">${request.quoteAmount}</span></p>
                                <p><strong>Completion Time:</strong> ${request.estimatedTime}</p>
                                ${request.quoteNotes ? `<p><strong>Notes:</strong> ${request.quoteNotes}</p>` : ''}
                            </div>
                        </div>
                    `;
                });

                completedJobsList.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading completed jobs:', error);
                completedJobsList.innerHTML = '<p style="text-align: center; color: #f44336; padding: 2rem;">Error loading completed jobs. Please try again.</p>';
            }
        }

        // Quote management functions
        function showQuoteForm(requestId) {
            document.getElementById('quoteForm' + requestId).classList.remove('hidden');
        }

        function hideQuoteForm(requestId) {
            document.getElementById('quoteForm' + requestId).classList.add('hidden');
        }

        // Submit quote to Firebase
        async function submitQuote(requestId) {
            const quoteAmount = document.getElementById('quoteAmount' + requestId).value;
            const estimatedTime = document.getElementById('estimatedTime' + requestId).value;
            const quoteNotes = document.getElementById('quoteNotes' + requestId).value;

            if (!quoteAmount || !estimatedTime) {
                alert('Please fill in the quote amount and estimated time');
                return;
            }

            try {
                await db.collection('requests').doc(requestId).update({
                    status: 'quoted',
                    quotedBy: 'contractor',
                    quotedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    quoteAmount: parseFloat(quoteAmount),
                    estimatedTime: estimatedTime,
                    quoteNotes: quoteNotes
                });

                alert('Quote submitted successfully! Waiting for Project Manager approval.');
                hideQuoteForm(requestId);
                displayRequests(); // Refresh the view
                
            } catch (error) {
                console.error('Error submitting quote:', error);
                alert('Error submitting quote. Please try again.');
            }
        }

        // Approve quote
        async function approveQuote(requestId) {
            try {
                const doc = await db.collection('requests').doc(requestId).get();
                const request = doc.data();
                
                if (confirm(`Approve quote of ${request.quoteAmount} for "${request.projectName}"?`)) {
                    await db.collection('requests').doc(requestId).update({
                        status: 'approved',
                        approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    alert('Quote approved! The job is now active.');
                }
            } catch (error) {
                console.error('Error approving quote:', error);
                alert('Error approving quote. Please try again.');
            }
        }

        // Reject quote
        async function rejectQuote(requestId) {
            try {
                const doc = await db.collection('requests').doc(requestId).get();
                const request = doc.data();
                
                if (confirm(`Reject quote for "${request.projectName}"? This will make it available for new quotes.`)) {
                    await db.collection('requests').doc(requestId).update({
                        status: 'pending',
                        quotedBy: null,
                        quotedAt: null,
                        quoteAmount: null,
                        estimatedTime: null,
                        quoteNotes: null
                    });

                    alert('Quote rejected. The job is now open for new quotes.');
                }
            } catch (error) {
                console.error('Error rejecting quote:', error);
                alert('Error rejecting quote. Please try again.');
            }
        }

        // Complete job
        async function completeJob(requestId) {
            try {
                const doc = await db.collection('requests').doc(requestId).get();
                const request = doc.data();
                
                if (confirm(`Mark "${request.projectName}" as complete?`)) {
                    await db.collection('requests').doc(requestId).update({
                        status: 'completed',
                        completedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    alert(`Job "${request.projectName}" has been marked as complete!`);
                }
            } catch (error) {
                console.error('Error completing job:', error);
                alert('Error completing job. Please try again.');
            }
        }

        // Update counters
        async function updateCounters() {
            try {
                const [pendingQuotes, approvedJobs, completedJobs, quotedJobs, myJobs, completedContractor] = await Promise.all([
                    db.collection('requests').where('status', '==', 'quoted').get(),
                    db.collection('requests').where('status', '==', 'approved').get(),
                    db.collection('requests').where('status', '==', 'completed').get(),
                    db.collection('requests').where('status', '==', 'quoted').where('quotedBy', '==', 'contractor').get(),
                    db.collection('requests').where('status', '==', 'approved').where('quotedBy', '==', 'contractor').get(),
                    db.collection('requests').where('status', '==', 'completed').where('quotedBy', '==', 'contractor').get()
                ]);

                // Update manager counters
                const pendingQuotesCount = document.getElementById('pendingQuotesCount');
                const approvedJobsCount = document.getElementById('approvedJobsCount');
                const completedJobsPMCount = document.getElementById('completedJobsPMCount');
                
                if (pendingQuotesCount) pendingQuotesCount.textContent = pendingQuotes.size;
                if (approvedJobsCount) approvedJobsCount.textContent = approvedJobs.size;
                if (completedJobsPMCount) completedJobsPMCount.textContent = completedJobs.size;

                // Update contractor counters
                const quotedJobsCount = document.getElementById('quotedJobsCount');
                const myJobsCount = document.getElementById('myJobsCount');
                const completedJobsCount = document.getElementById('completedJobsCount');
                
                if (quotedJobsCount) quotedJobsCount.textContent = quotedJobs.size;
                if (myJobsCount) myJobsCount.textContent = myJobs.size;
                if (completedJobsCount) completedJobsCount.textContent = completedContractor.size;

            } catch (error) {
                console.error('Error updating counters:', error);
            }
        }

        // Image modal functions
        function openModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'block';
            modalImg.src = imageSrc;
        }

        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // Utility function
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Close modal when clicking outside the image
        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Add sample data to Firebase (only run once)
        async function addSampleDataToFirebase() {
            try {
                // Check if sample data already exists
                const existingData = await db.collection('requests').limit(1).get();
                if (!existingData.empty) {
                    console.log('Sample data already exists in Firebase');
                    return;
                }

                console.log('Adding sample data to Firebase...');
                
                const sampleRequests = [
                    {
                        serviceType: 'contractor',
                        projectName: 'Office Renovation',
                        description: 'Complete renovation of the main office space including flooring, painting, and electrical work.',
                        priority: 'high',
                        deadline: '2025-06-15',
                        images: [],
                        status: 'pending',
                        submittedAt: firebase.firestore.Timestamp.fromDate(new Date('2025-05-29')),
                        submittedBy: 'manager',
                        quotedBy: null,
                        quotedAt: null,
                        quoteAmount: null,
                        estimatedTime: null,
                        quoteNotes: null,
                        approvedAt: null,
                        completedAt: null
                    },
                    {
                        serviceType: 'handyman',
                        projectName: 'Fix Leaky Faucets',
                        description: 'Multiple faucets in the building need repair or replacement.',
                        priority: 'medium',
                        deadline: '2025-06-10',
                        images: [],
                        status: 'approved',
                        submittedAt: firebase.firestore.Timestamp.fromDate(new Date('2025-05-28')),
                        submittedBy: 'manager',
                        quotedBy: 'contractor',
                        quotedAt: firebase.firestore.Timestamp.fromDate(new Date('2025-05-29')),
                        quoteAmount: 350,
                        estimatedTime: '2-3 days',
                        quoteNotes: 'Will include new faucet parts if needed',
                        approvedAt: firebase.firestore.Timestamp.fromDate(new Date('2025-05-30')),
                        completedAt: null
                    },
                    {
                        serviceType: 'cleaning',
                        projectName: 'Deep Clean Conference Rooms',
                        description: 'Deep cleaning service needed for all conference rooms before important client meetings.',
                        priority: 'high',
                        deadline: '2025-06-05',
                        images: [],
                        status: 'pending',
                        submittedAt: firebase.firestore.Timestamp.fromDate(new Date('2025-05-27')),
                        submittedBy: 'manager',
                        quotedBy: null,
                        quotedAt: null,
                        quoteAmount: null,
                        estimatedTime: null,
                        quoteNotes: null,
                        approvedAt: null,
                        completedAt: null
                    },
                    {
                        serviceType: 'contractor',
                        projectName: 'Kitchen Remodel',
                        description: 'Complete kitchen renovation including cabinets, countertops, and appliances installation.',
                        priority: 'medium',
                        deadline: '2025-05-20',
                        images: [],
                        status: 'completed',
                        submittedAt: firebase.firestore.Timestamp.fromDate(new Date('2025-05-15')),
                        submittedBy: 'manager',
                        quotedBy: 'contractor',
                        quotedAt: firebase.firestore.Timestamp.fromDate(new Date('2025-05-16')),
                        quoteAmount: 15000,
                        estimatedTime: '3-4 weeks',
                        quoteNotes: 'Includes all materials and labor',
                        approvedAt: firebase.firestore.Timestamp.fromDate(new Date('2025-05-17')),
                        completedAt: firebase.firestore.Timestamp.fromDate(new Date('2025-05-25'))
                    }
                ];

                // Add each sample request to Firebase
                for (const requestData of sampleRequests) {
                    await db.collection('requests').add(requestData);
                }

                console.log('Sample data added successfully!');
                updateFirebaseStatus('connected', 'ðŸ”¥ Firebase Ready');
                
            } catch (error) {
                console.error('Error adding sample data:', error);
            }
        }

        // Initialize app when page loads
        window.addEventListener('load', async () => {
            console.log('Initializing Firebase app...');
            updateFirebaseStatus('connecting', 'Connecting...');
            
            try {
                await initializeFirebase();
                await addSampleDataToFirebase();
                updateFirebaseStatus('connected', 'ðŸ”¥ Firebase Ready');
            } catch (error) {
                console.error('Failed to initialize Firebase:', error);
                updateFirebaseStatus('error', 'âŒ Firebase Error');
            }
        });

        // Clean up listeners when page unloads
        window.addEventListener('beforeunload', () => {
            if (unsubscribeRequests) {
                unsubscribeRequests();
            }
        });
    </script>
</body>
</html>
